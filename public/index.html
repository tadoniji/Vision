<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vision - TMDB Enhanced</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&amp;display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0f172a;
            --card-color: #1e293b;
            --text-color: #f1f5f9;
            --accent-color: #38bdf8;
            --accent-hover: #0ea5e9;
            --seen-color: #22c55e;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        
        /* Layout */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .content-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        .sidebar {
            width: 300px;
            background: var(--card-color);
            border-left: 1px solid #334155;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 1000;
            transform: translateX(100%);
        }
        .sidebar.open { transform: translateX(0); }

        /* Header */
        header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid #334155;
        }
        
        h1 { margin: 0; font-weight: 800; letter-spacing: -1px; cursor: pointer; }
        
        .controls { display: flex; gap: 15px; }
        .icon-btn {
            background: none; border: none; color: var(--text-color);
            font-size: 1.2rem; cursor: pointer; padding: 8px;
            border-radius: 50%; transition: background 0.2s;
        }
        .icon-btn:hover { background: #334155; color: var(--accent-color); }

        /* Search */
        .search-container {
            max-width: 800px;
            margin: 20px auto;
            position: relative;
        }
        .search-input {
            width: 100%;
            padding: 15px 20px;
            border-radius: 12px;
            border: 2px solid #334155;
            background-color: var(--card-color);
            color: white;
            font-size: 1.1rem;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        .search-input:focus { border-color: var(--accent-color); outline: none; }

        /* Discovery / Home Sections */
        .section-header { margin: 30px 0 15px 0; font-size: 1.4rem; font-weight: 700; color: white; }
        .horizontal-scroll {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding-bottom: 20px;
            scroll-behavior: smooth;
        }
        .horizontal-scroll::-webkit-scrollbar { height: 8px; }
        .horizontal-scroll::-webkit-scrollbar-track { background: #1e293b; border-radius: 4px; }
        .horizontal-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .horizontal-scroll::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }

        .media-card {
            flex: 0 0 160px;
            background-color: var(--card-color);
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
            aspect-ratio: 2/3;
        }
        .media-card:hover { transform: scale(1.05); z-index: 10; }
        .media-card img { width: 100%; height: 100%; object-fit: cover; }
        .media-title-overlay {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            padding: 20px 10px 10px;
            font-size: 0.85rem; font-weight: bold;
            text-shadow: 0 1px 2px black;
            pointer-events: none;
        }

        /* Search Grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
            display: none; /* Hidden by default */
        }

        /* Details View */
        .details-view { max-width: 1000px; margin: 0 auto; display: none; animation: fadeIn 0.3s; }
        .details-header { display: flex; gap: 30px; margin-bottom: 30px; flex-wrap: wrap; }
        .details-poster { width: 250px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .details-info { flex: 1; min-width: 300px; }
        .details-title { font-size: 2.5rem; font-weight: 800; margin: 0 0 10px 0; }
        .details-overview { line-height: 1.6; color: #cbd5e1; margin-bottom: 20px; }
        
        .season-list { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; }
        .season-chip {
            padding: 8px 16px; background: #334155; border-radius: 20px; cursor: pointer; white-space: nowrap;
            border: 1px solid transparent; transition: all 0.2s;
        }
        .season-chip:hover { background: #475569; }
        .season-chip.active { background: var(--accent-color); color: #000; font-weight: bold; }

        .episodes-list { display: flex; flex-direction: column; gap: 10px; }
        .episode-item {
            display: flex; align-items: center; gap: 15px;
            padding: 15px; background: #1e293b; border-radius: 8px;
            transition: background 0.2s; cursor: pointer;
            border-left: 4px solid transparent;
        }
        .episode-item:hover { background: #334155; }
        .episode-item.watched { border-left-color: var(--seen-color); opacity: 0.7; }
        .episode-number { font-weight: 800; color: #64748b; width: 30px; }
        .episode-title { flex: 1; font-weight: 600; }
        .watch-btn {
            padding: 8px 16px; background: var(--accent-color); border: none; border-radius: 6px;
            color: #000; font-weight: bold; cursor: pointer;
        }
        .watch-btn:hover { background: var(--accent-hover); }

        /* Sources Modal */
        .sources-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 2000;
            display: none; justify-content: center; align-items: center;
        }
        .sources-content {
            background: var(--bg-color); width: 90%; max-width: 600px; max-height: 80vh;
            border-radius: 12px; padding: 20px; display: flex; flex-direction: column;
            border: 1px solid #334155;
        }
        .sources-list { overflow-y: auto; flex: 1; margin-top: 15px; display: flex; flex-direction: column; gap: 10px; }
        .source-item {
            padding: 15px; background: var(--card-color); border-radius: 8px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
        }
        .source-item:hover { background: #334155; }

        /* Player */
        #player-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 3000; display: none;
            flex-direction: column;
        }
        #video-frame { flex: 1; border: none; width: 100%; height: 100%; }
        .player-bar {
            padding: 10px; background: #1e293b; display: flex; justify-content: space-between; align-items: center;
        }

        /* Notepad Sidebar */
        .notes-area {
            width: 100%; height: 100%; background: transparent; border: none;
            color: var(--text-color); padding: 20px; font-family: inherit; font-size: 1rem; resize: none;
            outline: none; box-sizing: border-box;
        }
        .sidebar-header {
            padding: 20px; border-bottom: 1px solid #334155; font-weight: bold; display: flex; justify-content: space-between;
        }

        /* Settings Modal */
        .modal {
            background: var(--card-color); padding: 30px; border-radius: 12px; width: 400px;
            border: 1px solid #475569;
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: #94a3b8; }
        .form-group input { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <header>
        <h1 onclick="showHome()">VISION</h1>
        <div class="controls">
            <button class="icon-btn" onclick="toggleNotes()" title="Bloc-notes">üìù</button>
            <button class="icon-btn" onclick="openSettings()" title="Param√®tres">‚öôÔ∏è</button>
        </div>
    </header>

    <div class="main-container">
        <div class="content-area" id="main-content">
            <!-- Home / Search View -->
            <div id="home-view">
                <div class="search-container">
                    <input type="text" class="search-input" id="search-input" placeholder="Rechercher un film ou une s√©rie..." onkeypress="handleEnter(event)" oninput="handleInput(event)">
                </div>
                
                <!-- Discovery Sections -->
                <div id="discovery-container">
                    <div class="section-header">Tendances de la semaine</div>
                    <div class="horizontal-scroll" id="trending-list">
                        <!-- Items -->
                    </div>

                    <div class="section-header">Films Populaires</div>
                    <div class="horizontal-scroll" id="movies-list">
                        <!-- Items -->
                    </div>

                    <div class="section-header">S√©ries Populaires</div>
                    <div class="horizontal-scroll" id="tv-list">
                        <!-- Items -->
                    </div>
                </div>

                <!-- Search Results -->
                <h3 id="search-title" style="max-width:1200px; margin: 0 auto 20px; display:none;">R√©sultats</h3>
                <div class="grid" id="results-grid">
                    <!-- Results injected here -->
                </div>
            </div>

            <!-- Details View -->
            <div id="details-view" class="details-view">
                <button class="icon-btn" onclick="showHome()" style="margin-bottom:20px;">‚Üê Retour</button>
                <div class="details-header" id="details-header">
                    <!-- Header info injected here -->
                </div>
                
                <div id="seasons-container" style="display:none;">
                    <h3>Saisons</h3>
                    <div class="season-list" id="season-list"></div>
                    
                    <h3>√âpisodes</h3>
                    <div class="episodes-list" id="episodes-list"></div>
                </div>
            </div>
        </div>

        <!-- Notepad Sidebar -->
        <div class="sidebar" id="notes-sidebar">
            <div class="sidebar-header">
                <span>Bloc-notes</span>
                <button class="icon-btn" onclick="toggleNotes()">‚úï</button>
            </div>
            <textarea class="notes-area" id="notes-area" placeholder="√âcrivez vos notes ici... (sauvegarde auto)"></textarea>
        </div>
    </div>

    <!-- Sources Modal -->
    <div id="sources-modal" class="sources-modal">
        <div class="sources-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Sources disponibles</h3>
                <button class="icon-btn" onclick="closeSources()">‚úï</button>
            </div>
            <div id="loading-sources" style="text-align:center; padding:20px; color:var(--accent-color);">Recherche en cours...</div>
            <div class="sources-list" id="sources-list"></div>
        </div>
    </div>

    <!-- Player Overlay -->
    <div id="player-overlay">
        <div class="player-bar">
            <span id="player-title" style="font-weight:bold;">Titre</span>
            <button class="icon-btn" onclick="closePlayer()">Fermer ‚úï</button>
        </div>
        <iframe id="video-frame" src="" allowfullscreen></iframe>
    </div>

    <!-- Settings Modal Overlay -->
    <div id="settings-overlay" class="sources-modal">
        <div class="modal">
            <h2>Configuration</h2>
            <div class="form-group">
                <label>Cl√© API TMDB (Requise pour les m√©tadonn√©es)</label>
                <input type="text" id="tmdb-key-input" placeholder="Ins√©rer votre cl√© API v3">
            </div>
            <p style="font-size:0.8rem; color:#94a3b8; margin-bottom:20px;">
                Vous pouvez obtenir une cl√© gratuitement sur themoviedb.org.
            </p>
            
            <div class="form-group">
                 <label>Providers Activ√©s</label>
                 <div id="providers-settings-list" style="max-height:150px; overflow-y:auto; border:1px solid #334155; padding:10px; border-radius:6px;"></div>
            </div>

            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button class="icon-btn" onclick="closeSettings()" style="font-size:1rem; border:1px solid #334155; border-radius:6px;">Annuler</button>
                <button class="icon-btn" onclick="saveSettings()" style="font-size:1rem; background:var(--accent-color); color:black; border-radius:6px;">Sauvegarder</button>
            </div>
        </div>
    </div>

    <script>
        const IMG_BASE = 'https://image.tmdb.org/t/p/w500';
        let config = {};
        let progress = {};
        let currentMedia = null; // { type, id, title, season, episode }
        let currentSourceResults = [];

        // --- INIT ---
        window.onload = async () => {
            await loadConfig();
            await loadProgress();
            await loadNotes();
            
            if (!config.tmdbApiKey) {
                openSettings();
            } else {
                loadDiscovery();
            }
        };

        // --- API CALLS ---
        async function loadConfig() {
            try {
                const res = await fetch('/api/config');
                config = await res.json();
            } catch(e) { console.error(e); }
        }

        async function saveConfigData() {
            await fetch('/api/config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(config)
            });
        }

        async function loadProgress() {
            try {
                const res = await fetch('/api/progress');
                progress = await res.json();
            } catch(e) {}
        }

        async function loadNotes() {
            try {
                const res = await fetch('/api/notes');
                const data = await res.json();
                document.getElementById('notes-area').value = data.content || '';
            } catch(e) {}
        }

        async function loadDiscovery() {
            if(!config.tmdbApiKey) return;

            fetchSection('/api/tmdb/trending', 'trending-list');
            fetchSection('/api/tmdb/popular/movie', 'movies-list');
            fetchSection('/api/tmdb/popular/tv', 'tv-list');
        }

        async function fetchSection(endpoint, containerId) {
            try {
                const res = await fetch(endpoint);
                const data = await res.json();
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                
                data.forEach(item => {
                    const el = createMediaCard(item);
                    container.appendChild(el);
                });
            } catch(e) { console.error(e); }
        }

        function createMediaCard(item) {
            const card = document.createElement('div');
            card.className = 'media-card';
            card.onclick = () => loadMediaDetails(item.media_type, item.id);
            
            const img = item.poster_path ? `${IMG_BASE}${item.poster_path}` : null;
            const title = item.title || item.name;

            card.innerHTML = `
                ${img ? `<img src="${img}" alt="${title}" loading="lazy">` : '<div style="padding:10px;">No IMG</div>'}
                <div class="media-title-overlay">${title}</div>
            `;
            return card;
        }

        // --- NAVIGATION & UI ---
        function showHome() {
            document.getElementById('home-view').style.display = 'block';
            document.getElementById('details-view').style.display = 'none';
        }

        function showDetails() {
            document.getElementById('home-view').style.display = 'none';
            document.getElementById('details-view').style.display = 'block';
        }

        function handleInput(e) {
            const query = e.target.value;
            const discovery = document.getElementById('discovery-container');
            const grid = document.getElementById('results-grid');
            const title = document.getElementById('search-title');

            if (query.length > 0) {
                discovery.style.display = 'none';
                grid.style.display = 'grid';
                title.style.display = 'block';
            } else {
                discovery.style.display = 'block';
                grid.style.display = 'none';
                title.style.display = 'none';
                grid.innerHTML = ''; // clear results
            }
        }

        function handleEnter(e) {
            if (e.key === 'Enter') searchTMDB();
        }

        async function searchTMDB() {
            const query = document.getElementById('search-input').value;
            if (!query) return;
            
            if (!config.tmdbApiKey) {
                alert("Veuillez configurer votre cl√© API TMDB dans les param√®tres.");
                openSettings();
                return;
            }

            const grid = document.getElementById('results-grid');
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center;">Recherche...</div>';
            
            // Ensure UI state
            document.getElementById('discovery-container').style.display = 'none';
            document.getElementById('search-title').style.display = 'block';
            grid.style.display = 'grid';

            try {
                const res = await fetch(`/api/tmdb/search?query=${encodeURIComponent(query)}`);
                const results = await res.json();
                
                grid.innerHTML = '';
                if (results.error) {
                    grid.innerHTML = `<div style="color:red; grid-column:1/-1;">Erreur: ${results.error}</div>`;
                    return;
                }

                if (results.length === 0) {
                    grid.innerHTML = '<div style="grid-column:1/-1; text-align:center;">Aucun r√©sultat.</div>';
                    return;
                }

                results.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'media-card'; 
                    card.style.flex = 'none'; // Reset flex for grid
                    card.style.width = '100%'; // Full width of grid cell
                    
                    card.onclick = () => loadMediaDetails(item.media_type, item.id);
                    
                    const img = item.poster_path ? `${IMG_BASE}${item.poster_path}` : null;
                    const title = item.title || item.name;

                    card.innerHTML = `
                        ${img ? `<img src="${img}" alt="${title}">` : '<div style="padding:20px;">No Image</div>'}
                        <div class="media-title-overlay">${title}</div>
                    `;
                    grid.appendChild(card);
                });

            } catch(e) {
                grid.innerHTML = '<div style="color:red; grid-column:1/-1;">Erreur r√©seau</div>';
            }
        }

        async function loadMediaDetails(type, id) {
            // Fetch full details
            const res = await fetch(`/api/tmdb/details/${type}/${id}`);
            const data = await res.json();
            
            if (!data) return alert("Erreur chargement d√©tails");

            currentMedia = { type, id, title: data.title || data.name };
            
            // Render Header
            const header = document.getElementById('details-header');
            const img = data.poster_path ? `${IMG_BASE}${data.poster_path}` : '';
            
            let actionButton = '';
            if (type === 'movie') {
                actionButton = `<button class="watch-btn" onclick="findSources('${data.title.replace(/'/g, "\'")}', 'movie')">REGARDER LE FILM</button>`;
            }

            header.innerHTML = `
                ${img ? `<img src="${img}" class="details-poster">` : ''}
                <div class="details-info">
                    <h2 class="details-title">${data.title || data.name}</h2>
                    <div style="margin-bottom:15px; color:#94a3b8;">${data.release_date || data.first_air_date || ''} ‚Ä¢ ${data.genres.map(g=>g.name).join(', ')}</div>
                    <div class="details-overview">${data.overview}</div>
                    ${actionButton}
                </div>
            `;

            if (type === 'tv') {
                document.getElementById('seasons-container').style.display = 'block';
                renderSeasons(data.id, data.seasons);
            } else {
                document.getElementById('seasons-container').style.display = 'none';
            }

            showDetails();
        }

        function renderSeasons(tvId, seasons) {
            const list = document.getElementById('season-list');
            list.innerHTML = '';
            
            seasons.forEach(season => {
                if (season.season_number === 0 && season.episode_count === 0) return;
                
                const chip = document.createElement('div');
                chip.className = 'season-chip';
                chip.innerText = season.name;
                chip.onclick = () => {
                    document.querySelectorAll('.season-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    loadEpisodes(tvId, season.season_number);
                };
                list.appendChild(chip);
            });

            const last = progress[tvId];
            if (last) {
                const targetSeason = last.season || 1;
                loadEpisodes(tvId, targetSeason);
                
                setTimeout(() => {
                     const chips = document.querySelectorAll('.season-chip');
                }, 100);
            } else if (seasons.length > 0) {
                const s1 = seasons.find(s => s.season_number === 1);
                loadEpisodes(tvId, s1 ? 1 : seasons[0].season_number);
            }
        }

        async function loadEpisodes(tvId, seasonNum) {
            const container = document.getElementById('episodes-list');
            container.innerHTML = 'Chargement...';
            
            document.querySelectorAll('.season-chip').forEach(c => {
                if(c.innerText.includes(`Saison ${seasonNum}`) || c.innerText === `Saison ${seasonNum}` || (seasonNum===1 && c.innerText==="Saison 1")) {
                     c.classList.add('active');
                } else {
                     c.classList.remove('active');
                }
            });

            const res = await fetch(`/api/tmdb/season/${tvId}/${seasonNum}`);
            const data = await res.json();
            
            container.innerHTML = '';
            
            if (!data || !data.episodes) {
                container.innerHTML = 'Erreur chargement √©pisodes';
                return;
            }

            data.episodes.forEach(ep => {
                const el = document.createElement('div');
                const isLastWatched = progress[tvId] && progress[tvId].season == seasonNum && progress[tvId].episode == ep.episode_number;

                el.className = `episode-item ${isLastWatched ? 'watched' : ''}`;
                el.innerHTML = `
                    <div class="episode-number">${ep.episode_number}</div>
                    <div class="episode-title">
                        ${ep.name}
                        ${isLastWatched ? '<span style="font-size:0.7em; color:var(--seen-color); margin-left:10px;">(Reprendre ici)</span>' : ''}
                    </div>
                    <button class="watch-btn" onclick="findSources('${currentMedia.title.replace(/'/g, "\'")}', 'tv', ${seasonNum}, ${ep.episode_number})">
                        Lecture
                    </button>
                `;
                container.appendChild(el);
            });
        }

        // --- SOURCES & PLAYBACK ---
        async function findSources(title, type, season, episode) {
            document.getElementById('sources-modal').style.display = 'flex';
            document.getElementById('loading-sources').style.display = 'block';
            document.getElementById('sources-list').innerHTML = '';

            let query = title;
            if (type === 'tv') {
                query += ` Saison ${season} √âpisode ${episode}`;
                currentMedia.season = season;
                currentMedia.episode = episode;
            } else {
                currentMedia.season = null;
                currentMedia.episode = null;
            }

            try {
                const res = await fetch('/api/sources', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ query })
                });
                const data = await res.json();
                
                document.getElementById('loading-sources').style.display = 'none';
                
                // Cache results
                currentSourceResults = data.results || [];
                renderSourcesList();

            } catch(e) {
                document.getElementById('loading-sources').innerHTML = 'Erreur recherche sources';
            }
        }

        function renderSourcesList() {
            const list = document.getElementById('sources-list');
            list.innerHTML = '';

            if (currentSourceResults.length === 0) {
                list.innerHTML = '<div style="text-align:center;">Aucune source trouv√©e pour cette recherche.</div>';
                return;
            }

            currentSourceResults.forEach(source => {
                const item = document.createElement('div');
                item.className = 'source-item';
                item.innerHTML = `
                    <div>
                        <div style="font-weight:bold;">${source.title}</div>
                        <div style="font-size:0.8rem; color:#94a3b8;">${source.providerName}</div>
                    </div>
                    <div style="color:var(--accent-color);">‚ñ∂</div>
                `;
                item.onclick = () => {
                    if (source.isExternal) window.open(source.url, '_blank');
                    else launchSource(source);
                };
                list.appendChild(item);
            });
        }

        async function launchSource(source) {
            const list = document.getElementById('sources-list');
            list.innerHTML = `
                <div style="margin-bottom:10px;">
                    <button class="icon-btn" onclick="renderSourcesList()" style="font-size:0.9rem; background:#334155; border-radius:6px; padding:5px 10px;">‚Üê Retour</button>
                </div>
                <div style="text-align:center; padding:20px;">Chargement du lecteur depuis ${source.providerName}...</div>
            `;

            try {
                const res = await fetch(`/api/anime/${source.provider}/${encodeURIComponent(source.slug)}`);
                const data = await res.json();
                
                list.innerHTML = `
                    <div style="margin-bottom:10px; display:flex; align-items:center; justify-content:space-between;">
                        <button class="icon-btn" onclick="renderSourcesList()" style="font-size:0.9rem; background:#334155; border-radius:6px; padding:5px 10px;">‚Üê Retour</button>
                        <small>${source.providerName}</small>
                    </div>
                `;
                
                let targetEp = null;
                
                if (currentMedia.type === 'movie') {
                    targetEp = data.results[0];
                } else {
                    // Filter attempts
                    const targetSeason = currentMedia.season;
                    const targetEpNum = currentMedia.episode;
                    
                    let filtered = data.results;
                    
                    // Try to filter by exact season/episode
                    const matches = data.results.filter(ep => {
                        // Normalize season string from provider (e.g. "Saison 1", "saison1", "1")
                        // We check if the provider season string CONTAINS the target number
                        // This is loose but usually works for "Saison X".
                        // Be careful with "Saison 11" containing "1".
                        
                        // Better parsing: extract first number
                        const epSeasonStr = (ep.season || "").toLowerCase();
                        const epSeasonNum = parseInt(epSeasonStr.replace(/\D/g, '')) || 1; // Default to 1 if parsing fails
                        
                        // Normalize episode number
                        const epNum = parseInt(ep.episode);
                        
                        return epSeasonNum === targetSeason && epNum === targetEpNum;
                    });
                    
                    if (matches.length > 0) {
                        filtered = matches;
                        list.innerHTML = `<h4>Saison ${targetSeason} √âpisode ${targetEpNum} (${matches.length} options)</h4>`;
                    } else {
                        list.innerHTML = `<h4>Tous les √©pisodes (S√©lection auto √©chou√©e)</h4>`;
                    }

                    const subList = document.createElement('div');
                    subList.style.display = 'flex';
                    subList.style.flexWrap = 'wrap';
                    subList.style.gap = '10px';
                    
                    if (filtered.length === 0) {
                         list.innerHTML += "<div>Aucun √©pisode correspondant trouv√© dans la source.</div>";
                    }

                    filtered.forEach(ep => {
                        ep.providers.forEach(prov => {
                            const btn = document.createElement('button');
                            btn.className = 'watch-btn';
                            btn.style.background = '#334155';
                            // Label: [VF] Lecteur 1
                            btn.innerText = `[${ep.type || '?'}] ${prov.name}`;
                            btn.onclick = () => {
                                playVideo(prov.url);
                            };
                            subList.appendChild(btn);
                        });
                    });
                    list.appendChild(subList);
                    return;
                }

                if (targetEp && targetEp.providers && targetEp.providers.length > 0) {
                     playVideo(targetEp.providers[0].url);
                } else {
                    list.innerHTML += "Pas de lecteur trouv√©.";
                }

            } catch(e) {
                list.innerHTML = `
                    <div style="margin-bottom:10px;">
                        <button class="icon-btn" onclick="renderSourcesList()" style="font-size:0.9rem; background:#334155; border-radius:6px; padding:5px 10px;">‚Üê Retour</button>
                    </div>
                    <div>Erreur chargement lecteur: ${e.message}</div>
                `;
            }
        }

        function playVideo(url) {
            closeSources();
            document.getElementById('video-frame').src = url;
            document.getElementById('player-overlay').style.display = 'flex';
            document.getElementById('player-title').innerText = currentMedia.title;
            
            // Save History
            fetch('/api/history', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    tmdbId: currentMedia.id,
                    slug: currentMedia.title, // Fallback
                    title: currentMedia.title,
                    season: currentMedia.season,
                    episode: currentMedia.episode
                })
            });
            
            // Update local progress
            if (currentMedia.type === 'tv') {
                progress[currentMedia.id] = {
                    season: currentMedia.season,
                    episode: currentMedia.episode,
                    timestamp: new Date().toISOString()
                };
            }
        }

        // --- NOTES ---
        function toggleNotes() {
            document.getElementById('notes-sidebar').classList.toggle('open');
        }

        let noteTimeout;
        document.getElementById('notes-area').addEventListener('input', (e) => {
            clearTimeout(noteTimeout);
            noteTimeout = setTimeout(() => {
                fetch('/api/notes', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ content: e.target.value })
                });
            }, 1000);
        });

        // --- SETTINGS ---
        function openSettings() {
            document.getElementById('settings-overlay').style.display = 'flex';
            document.getElementById('tmdb-key-input').value = config.tmdbApiKey || '';
            
            const list = document.getElementById('providers-settings-list');
            list.innerHTML = '';
            if (config.providers) {
                config.providers.forEach((p, idx) => {
                    const row = document.createElement('div');
                    row.innerHTML = `
                        <input type="checkbox" ${p.enabled ? 'checked' : ''} id="prov-${idx}">
                        <label for="prov-${idx}" style="display:inline; color:white;">${p.name}</label>
                    `;
                    list.appendChild(row);
                });
            }
        }

        function closeSettings() {
            document.getElementById('settings-overlay').style.display = 'none';
        }

        function saveSettings() {
            config.tmdbApiKey = document.getElementById('tmdb-key-input').value.trim();
            if (config.providers) {
                config.providers.forEach((p, idx) => {
                    const cb = document.getElementById(`prov-${idx}`);
                    if (cb) p.enabled = cb.checked;
                });
            }
            saveConfigData();
            closeSettings();
            loadDiscovery(); // Reload trends if key was added
        }

        function closeSources() {
            document.getElementById('sources-modal').style.display = 'none';
        }
        function closePlayer() {
            document.getElementById('player-overlay').style.display = 'none';
            document.getElementById('video-frame').src = '';
        }
    </script>
</body>
</html>